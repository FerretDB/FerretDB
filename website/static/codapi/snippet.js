(()=>{var H=/^([^:]+):(@?\S+)$/,f=class n{constructor(t,e,s){this.title=t,this.type=e,this.value=s}static parse(t){let e=H.exec(t);if(!e)return null;let s=e[1].replaceAll("_"," "),i=e[2][0]=="@"?"event":"command",o=e[2][0]=="@"?e[2].slice(1):e[2];return new n(s,i,o)}};var A=document.createElement("template");A.innerHTML=`
<button>Run</button>
<a href="#edit" hidden>Edit</a>
<codapi-status></codapi-status>
`;var p=class extends HTMLElement{constructor(){super()}connectedCallback(){this.ready||(this.render(),this.listen(),this.ready=!0)}render(){this.appendChild(A.content.cloneNode(!0)),this.run=this.querySelector("button"),this.edit=this.querySelector("a"),this.status=this.querySelector("codapi-status");let t=this.getAttribute("actions");this.addActions(t?t.split(" "):null)}listen(){this.run.addEventListener("click",t=>{this.dispatchEvent(new Event("run"))}),this.edit.addEventListener("click",t=>{t.preventDefault(),this.dispatchEvent(new Event("edit"))})}addActions(t){if(t)for(let e of t){let s=f.parse(e);if(!s)continue;let i=this.createButton(s);this.insertBefore(i,this.status)}}createButton(t){let e=document.createElement("a");return e.addEventListener("click",s=>{s.preventDefault();let i=new CustomEvent(t.type,{detail:t.value});this.dispatchEvent(i)}),e.innerText=t.title,e.href="#"+t.value,e}showRunning(){this.run.setAttribute("disabled",""),this.status.showRunning()}showFinished(t){this.run.removeAttribute("disabled"),this.status.showFinished(t)}showStatus(t){this.run.removeAttribute("disabled"),this.status.showMessage(t)}get editable(){return!this.edit.hasAttribute("hidden")}set editable(t){t?this.edit.removeAttribute("hidden"):this.edit.setAttribute("hidden","")}};var v={running:"Running...",failed:"\u2718 Failed",done:"\u2713 Done"},m=class extends HTMLElement{showRunning(){let t=this.getAttribute("running")||v.running;this.innerHTML=`
            <svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"><animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12" repeatCount="indefinite"/></path></svg>
            ${t}
        `}showFinished(t){if(!t.ok){this.innerText=this.getAttribute("failed")||v.failed;return}let e=this.getAttribute("done")||v.done;e=e.replace("$DURATION",t.duration),this.innerHTML=`
            ${e}
            <span data-ref>\u2022 <a href="https://codapi.org/">codapi</a></span>`}showMessage(t){this.innerText=t}};var d={text:"text",svg:"svg",html:"html",dom:"dom",hidden:"hidden"},k=document.createElement("template");k.innerHTML=`
<a href="#close">\u2715</a>
<pre><code></code></pre>
`;var O={[d.text]:n=>{let t=[];return n.stdout&&t.push(n.stdout),n.stderr&&t.push(n.stderr),document.createTextNode(t.join(`
`))},[d.svg]:n=>{if(n.stderr)return document.createTextNode(n.stderr);let t=new DOMParser().parseFromString(n.stdout,"image/svg+xml");return t.querySelector("parsererror")?document.createTextNode(n.stdout):t.documentElement},[d.html]:n=>{if(n.stderr)return document.createTextNode(n.stderr);let t=new DOMParser().parseFromString(n.stdout,"text/html");if(t.querySelector("parsererror"))return document.createTextNode(n.stdout);let e=document.createDocumentFragment();return Array.from(t.body.childNodes).forEach(s=>e.appendChild(s)),e},[d.dom]:n=>n.stderr?document.createTextNode(n.stderr):n.stdout,[d.hidden]:n=>n.stderr?document.createTextNode(n.stderr):null},w=class extends HTMLElement{constructor(){super()}connectedCallback(){this.ready||(this.appendChild(k.content.cloneNode(!0)),this.close=this.querySelector("a"),this.output=this.querySelector("pre > code"),this.close.addEventListener("click",t=>{t.preventDefault(),this.hide()}),this.ready=!0)}fadeOut(){this.style.opacity=.4}fadeIn(){setTimeout(()=>{this.style.opacity=""},100)}showResult(t){let e=O[this.mode](t);if(this.output.innerHTML="",!e){this.hide();return}this.output.appendChild(e),this.show()}showMessage(t){this.output.innerText=t,t?this.show():this.hide()}showError(t){let e=t.message+(t.stack?`
${t.stack}`:"");this.showMessage(e)}show(){this.removeAttribute("hidden")}hide(){this.setAttribute("hidden","")}get mode(){return this.getAttribute("mode")||d.text}set mode(t){t in d||(t=d.text),this.setAttribute("mode",t)}};async function g(n,t={}){let{timeout:e=1e4}=t,s=new AbortController,i=setTimeout(()=>s.abort(),e),o=await fetch(n,{...t,signal:s.signal});return clearTimeout(i),o}var q="https://api.codapi.org/v1",j="Something is wrong with Codapi.",I={400:"Bad request. Something is wrong with the request, not sure what.",404:"Unknown sandbox or command.",403:"Forbidden. Your domain is probably not allowed on Codapi.",413:"Request is too large. Try submitting less code.",429:"Too many requests. Try again in a few seconds."};async function P(n,t){try{let e=`${n||q}/exec`,s=await g(e,{method:"POST",headers:{accept:"application/json","content-type":"application/json"},body:JSON.stringify(t)});if(!s.ok){let i=I[s.status]||j;return{ok:!1,duration:0,stdout:"",stderr:`${s.status} - ${i}`}}return await s.json()}catch(e){throw new Error(`request to ${n} failed`,{cause:e})}}var S={init:()=>{},exec:P};function B(n,t){let e=n.indexOf(t);return e>=0?[n.slice(0,e),n.slice(e+t.length)]:[n,""]}var u={cut:B};async function U(n,t){try{let e=_(t.files[""]);e.url=W(e.url,n);let[s,i]=await J(e);return{ok:!0,duration:i,stdout:s,stderr:""}}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}}function _(n){let t=n.split(`
`),e=0,s=t[0].split(" ").filter(a=>a),[i,o]=s.length>=2?s:["GET",s[0]];e+=1;let r=[];for(let a=e;a<t.length;a++){let c=t[a].trim();if(c.startsWith("?")||c.startsWith("&"))r.push(c),e+=1;else break}let h={};for(let a=e;a<t.length;a++){let c=t[a].trim();if(c==="")break;let[N,R]=u.cut(c,":");h[N.trim()]=R.trim(),e+=1}let E=t.slice(e+1).join(`
`);return{method:i,url:o+r.join(""),headers:h,body:E}}function W(n,t){if(!t)return n;let e=new URL(n),s=new URL(t);return e.protocol=s.protocol,e.username=s.username,e.password=s.password,e.host=s.host,e.pathname=s.pathname,e.href}async function J(n){let t=new Date,e=await K(n),s=await G(e),i=new Date-t;return[s,i]}async function K(n){let t={method:n.method,headers:n.headers,body:n.body||void 0};return await g(n.url,t)}async function G(n){let t="HTTP/1.1",e=await n.text(),s=[`${t} ${n.status} ${n.statusText}`];for(let i of n.headers.entries())s.push(`${i[0]}: ${i[1]}`);return e&&s.push("",e),s.join(`
`)}var C={exec:U};var V=async function(){}.constructor;async function Y(n,t){try{let e=[];z(e);let[s,i]=await Z(t.files[""]);return{ok:!0,duration:i,stdout:s??e.join(`
`),stderr:""}}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}finally{Q()}}async function Z(n){let t=new V(n),e=new Date,s=await t(),i=new Date-e;return[s,i]}function z(n){let t=new Proxy(console,{get(e,s){return s==="log"||s==="error"||s==="warn"?(...i)=>{let o=i.map(r=>X(r)).join(" ");n.push(o),e[s](...i)}:e[s]}});window._console=window.console,window.console=t,window.addEventListener("error",e=>console.log(e.error))}function Q(){window.console=window._console,delete window._console}function X(n){switch(typeof n){case"undefined":return"undefined";case"object":return JSON.stringify(n);default:return n.toString()}}var L={exec:Y};var M={javascript:L.exec,fetch:C.exec};async function tt(n,t){try{return et(t)(n,t)}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}}function et(n){if(!(n.sandbox in M))throw Error(`unknown sandbox: ${n.sandbox}`);if(n.command!="run")throw Error(`unknown command: ${n.sandbox}.${n.command}`);return M[n.sandbox]}var F={init:()=>{},exec:tt};var nt="codapi",st="run",b=class{constructor({engine:t,sandbox:e,command:s,url:i,template:o,files:r}){let[h,E]=u.cut(e,":");this.engineName=t||nt,this.sandbox=h,this.version=E,this.command=s||st,this.url=i,this.template=o,this.files=r}get engine(){let t=window.Codapi.engines[this.engineName];if(!t)throw new Error(`unknown engine: ${this.engineName}`);return t}async execute(t,e){e=await this.prepare(e);let s=await this.loadFiles();return await this.engine.exec(this.url,{sandbox:this.sandbox,version:this.version,command:t||this.command,files:{"":e,...s}})}async prepare(t){if(!this.template)return t;let e="##CODE##",[s,i]=await $(this.template,it);return t=i.replace(e,()=>t),t}async loadFiles(){if(!this.files)return{};let t={};for(let e of this.files){let[s,i]=await $(e,ot);t[s]=i}return t}};async function $(n,t){if(n[0]=="#"){let o=n.slice(1),r=document.getElementById(o);if(!r)throw new Error(`element ${n} not found`);return[o,r.text]}let e=n.split("/").pop(),s=await fetch(n);if(s.status!=200)throw new Error(`file ${n} not found`);let i=await t(s);return[e,i]}async function it(n){return await n.text()}async function ot(n){if(n.headers.get("content-type")=="application/octet-stream"){let e=await n.blob();return await rt(e)}else return await n.text()}function rt(n){return new Promise(t=>{let e=new FileReader;e.readAsDataURL(n),e.onloadend=function(){t(e.result)}})}var at={codapi:S,browser:F};window.Codapi=window.Codapi||{};window.Codapi.engines={...window.Codapi.engines,...at};var dt=4,ut={fallback:"\u2718 Failed, using fallback"},l={unknown:"unknown",running:"running",failed:"failed",succeded:"succeded"},x={off:"off",basic:"basic",external:"external"},D=document.createElement("template");D.innerHTML=`
<codapi-toolbar></codapi-toolbar>
<codapi-output hidden></codapi-output>
`;var y=class extends HTMLElement{constructor(){super(),this.ready=!1,this.executor=null,this.snippet=null,this.toolbar=null,this.output=null,this.fallback=null}connectedCallback(){if(this.ready)return;let t=parseInt(this.getAttribute("init-delay"),10)||0;lt(()=>{this.init(),this.render(),this.listen(),this.ready=!0,this.dispatchEvent(new Event("load"))},t)}init(){let t=this.getAttribute("files");this.executor=new b({engine:this.getAttribute("engine"),sandbox:this.getAttribute("sandbox"),command:this.getAttribute("command"),url:this.getAttribute("url"),template:this.getAttribute("template"),files:t?t.split(" "):null}),this.dependsOn=this.getAttribute("depends-on"),this.state=l.unknown}render(){this.appendChild(D.content.cloneNode(!0));let t=this.findCodeElement();this.snippet=new T(t,this.editor,this.execute.bind(this)),this.toolbar=this.querySelector("codapi-toolbar");let e=this.getAttribute("actions");this.toolbar.addActions(e?e.split(" "):null);let s=this.toolbar.querySelector("codapi-status");this.hasAttribute("status-running")&&s.setAttribute("running",this.getAttribute("status-running")),this.hasAttribute("status-failed")&&s.setAttribute("failed",this.getAttribute("status-failed")),this.hasAttribute("status-done")&&s.setAttribute("done",this.getAttribute("status-done")),this.output=this.querySelector("codapi-output"),this.output.mode=this.getAttribute("output-mode"),this.hasAttribute("output")&&(this.fallback=this.extractFallback(this.getAttribute("output")))}listen(){this.toolbar.addEventListener("run",t=>{this.execute()}),this.toolbar.addEventListener("command",t=>{this.execute(t.detail)}),this.toolbar.addEventListener("event",t=>{this.dispatchEvent(new Event(t.detail))}),this.editor==x.basic&&(this.toolbar.editable=!0,this.toolbar.addEventListener("edit",t=>{this.snippet.focusEnd()})),this.snippet.addEventListener("hide",t=>{this.output.hide()})}findCodeElement(){if(!this.selector){let e=this.previousElementSibling;return e.querySelector("code")||e}let t;if(this.selector.startsWith("@prev")){let e=this.previousElementSibling,[s,i]=u.cut(this.selector," ");t=e.querySelector(i)}else t=document.querySelector(this.selector);if(!t)throw Error(`element not found: ${this.selector}`);return t}extractFallback(t){let e=this.findOutputElement(t),i=(e.querySelector("code")||e).innerText.trim();return e.parentElement.removeChild(e),{ok:!1,duration:0,stdout:i,stderr:""}}findOutputElement(t){if(!t)return this.nextElementSibling;let e;if(t.startsWith("@next")){let s=this.nextElementSibling,[i,o]=u.cut(o," ");e=s.querySelector(o)}else e=document.querySelector(t);if(!e)throw Error(`element not found: ${t}`);return e}async execute(t=void 0){if(!this.code){this.output.showMessage("(empty)");return}try{let e=ct(this);this.dispatchEvent(new CustomEvent("execute",{detail:e})),this.state=l.running,this.toolbar.showRunning(),this.output.fadeOut();let s=await this.executor.execute(t,e);this.state=s.ok?l.succeded:l.failed,this.toolbar.showFinished(s),this.output.showResult(s),this.dispatchEvent(new CustomEvent("result",{detail:s}))}catch(e){this.fallback?(this.toolbar.showStatus(ut.fallback),this.output.showResult(this.fallback)):(this.toolbar.showFinished({}),this.output.showMessage(e.message)),console.error(e),this.state=l.failed,this.dispatchEvent(new CustomEvent("error",{detail:e}))}finally{this.output.fadeIn()}}showStatus(t){this.toolbar.showStatus(t)}get selector(){return this.getAttribute("selector")}get editor(){return this.getAttribute("editor")||x.off}get code(){return this.snippet.value}set code(t){this.snippet.value=t}get state(){return this.getAttribute("state")}set state(t){this.setAttribute("state",t)}},T=class extends EventTarget{constructor(t,e,s){super(),this.el=t,this.mode=e,this.executeFunc=s,this.listen()}listen(){if(this.mode!=x.off){if(this.mode==x.external){this.el.addEventListener("keydown",this.handleExecute.bind(this));return}this.el.contentEditable="true",this.el.addEventListener("keydown",this.handleIndent.bind(this)),this.el.addEventListener("keydown",this.handleHide.bind(this)),this.el.addEventListener("keydown",this.handleExecute.bind(this)),this.el.addEventListener("paste",this.onPaste.bind(this)),this.onFocus=this.initEditor.bind(this),this.el.addEventListener("focus",this.onFocus)}}initEditor(t){let e=t.target;e.innerHTML.startsWith('<span class="line">')||e.innerHTML.startsWith('<span style="display:flex')?e.innerText=e.innerText.replace(/\n\n/g,`
`):e.innerHTML.includes("</span>")&&(e.innerText=e.innerText),e.removeEventListener("focus",this.onFocus),delete this.onFocus}handleIndent(t){t.key=="Tab"&&(t.preventDefault(),document.execCommand("insertHTML",!1," ".repeat(dt)))}handleHide(t){t.key=="Escape"&&(t.preventDefault(),this.dispatchEvent(new Event("hide")))}handleExecute(t){!t.ctrlKey&&!t.metaKey||t.keyCode!=10&&t.keyCode!=13||(t.preventDefault(),this.executeFunc())}onPaste(t){t.preventDefault();let e=(t.originalEvent||t).clipboardData.getData("text/plain");document.execCommand("insertText",!1,e)}focusEnd(){this.el.focus();let t=window.getSelection();t.selectAllChildren(this.el),t.collapseToEnd()}get value(){return this.el.innerText.trim().replace(/[\u00A0]/g," ")}set value(t){this.el.textContent=t}};function ct(n){let t=n.code,e=n.dependsOn?n.dependsOn.split(" "):[];for(let s of e){let i=document.getElementById(s);if(!i)throw new Error(`#${s} dependency not found`);t=i.code+`
`+t,i.dependsOn&&e.push(...i.dependsOn.split(" ").filter(o=>!e.includes(o)))}return t}function lt(n,t){if(t<=0){n();return}setTimeout(n,t)}window.customElements.get("codapi-snippet")||(window.CodapiSnippet=y,customElements.define("codapi-toolbar",p),customElements.define("codapi-status",m),customElements.define("codapi-output",w),customElements.define("codapi-snippet",y));})();

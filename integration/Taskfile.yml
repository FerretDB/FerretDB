# All commands should be invoked from the parent directory; see Taskfile.yml there.
---
version: 3

vars:
  DISABLE_FILTER_PUSHDOWN: false
  ENABLE_UNSAFE_SORT_PUSHDOWN: false
  BENCH_NAME: .
  BENCH_COUNT: 10
  BENCH_TIME: 5s
  BENCH_DOCS: 1000
  RACE_FLAG: -race={{and (ne OS "windows") (ne ARCH "arm") (ne ARCH "riscv64")}}
  BUILD_TAGS:

tasks:
  env-data:
    cmds:
      - >
        go test -count=1 {{.RACE_FLAG}} -run=TestEnvData
        -tags=ferretdb_testenvdata .
        -target-backend=ferretdb-postgresql
        -postgresql-url=postgres://username@127.0.0.1:5432/ferretdb
      - >
        go test -count=1 {{.RACE_FLAG}} -run=TestEnvData
        -tags=ferretdb_testenvdata .
        -target-backend=ferretdb-postgresql
        -postgresql-url=postgres://username:password@127.0.0.1:5433/ferretdb
      - >
        go test -count=1 {{.RACE_FLAG}} -run=TestEnvData
        -tags=ferretdb_testenvdata .
        -target-backend=ferretdb-sqlite
        -sqlite-url=file:../tmp/sqlite-tests/
      # no hana yet
      - >
        go test -count=1 {{.RACE_FLAG}} -run=TestEnvData
        -tags=ferretdb_testenvdata .
        -target-backend=mongodb
        -target-url='mongodb://127.0.0.1:47017/'

  integration-gen:
    cmds:
      - go generate -x ./...

  lint:
    desc: "Run linters"
    cmds:
      - ../bin/golangci-lint{{exeExt}} run --config=.golangci.yml
      - ../bin/golangci-lint{{exeExt}} run --config=.golangci-new.yml
      - ../bin/go-consistent{{exeExt}} -pedantic ./...
      - go vet -vettool=../bin/checkswitch{{exeExt}} ./...
      - go vet -vettool=../bin/checkcomments{{exeExt}} ./...

  integration-security:
    cmds:
      - ../bin/govulncheck{{exeExt}} -test ./...

  bench-integration-postgresql:
    desc: "Run benchmarks for `postgresql` backend"
    cmds:
      - >
        go test
        -timeout=0
        -tags={{.BUILD_TAGS}}
        -run=XXX
        -bench={{.BENCH_NAME}}
        -count={{.BENCH_COUNT}}
        -benchtime={{.BENCH_TIME}}
        -benchmem
        -bench-docs={{.BENCH_DOCS}}
        -log-level=error
        -target-backend=ferretdb-postgresql
        -postgresql-url=postgres://username@127.0.0.1:5432/ferretdb
        -disable-filter-pushdown={{.DISABLE_FILTER_PUSHDOWN}}
        -enable-unsafe-sort-pushdown={{.ENABLE_UNSAFE_SORT_PUSHDOWN}}
        | tee new-postgresql.txt
      - ../bin/benchstat{{exeExt}} old-postgresql.txt new-postgresql.txt

  bench-integration-sqlite:
    desc: "Run benchmarks for `sqlite` backend"
    cmds:
      - >
        go test
        -timeout=0
        -tags={{.BUILD_TAGS}}
        -run=XXX
        -bench={{.BENCH_NAME}}
        -count={{.BENCH_COUNT}}
        -benchtime={{.BENCH_TIME}}
        -benchmem
        -bench-docs={{.BENCH_DOCS}}
        -log-level=error
        -target-backend=ferretdb-sqlite
        -sqlite-url=file:../tmp/sqlite-tests/
        -disable-filter-pushdown={{.DISABLE_FILTER_PUSHDOWN}}
        -enable-unsafe-sort-pushdown={{.ENABLE_UNSAFE_SORT_PUSHDOWN}}
      - ../bin/benchstat{{exeExt}} old-sqlite.txt new-sqlite.txt

  bench-integration-mongodb:
    desc: "Run benchmarks for MongoDB"
    cmds:
      - >
        go test
        -timeout=0
        -tags={{.BUILD_TAGS}}
        -run=XXX
        -bench={{.BENCH_NAME}}
        -count={{.BENCH_COUNT}}
        -benchtime={{.BENCH_TIME}}
        -benchmem
        -bench-docs={{.BENCH_DOCS}}
        -target-backend=mongodb
        -target-url='mongodb://127.0.0.1:47017/'
        | tee new-mongodb.txt
      - ../bin/benchstat{{exeExt}} old-mongodb.txt new-mongodb.txt

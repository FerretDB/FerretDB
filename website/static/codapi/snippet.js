(()=>{var q=/^([^:]+):(@?\S+)$/,l=class n{constructor(t,e,s){this.title=t,this.type=e,this.value=s}static parse(t){let e=q.exec(t);if(!e)return null;let s=e[1].replaceAll("_"," "),i=e[2][0]=="@"?"event":"command",o=e[2][0]=="@"?e[2].slice(1):e[2];return new n(s,i,o)}};var v=document.createElement("template");v.innerHTML=`
<button>Run</button>
<a href="#edit" hidden>Edit</a>
<codapi-status></codapi-status>
`;var h=class extends HTMLElement{constructor(){super()}connectedCallback(){this.ready||(this.render(),this.listen(),this.ready=!0)}render(){this.appendChild(v.content.cloneNode(!0)),this.run=this.querySelector("button"),this.edit=this.querySelector("a"),this.status=this.querySelector("codapi-status")}listen(){this.run.addEventListener("click",t=>{this.dispatchEvent(new Event("run"))}),this.edit.addEventListener("click",t=>{t.preventDefault(),this.dispatchEvent(new Event("edit"))})}addActions(t){if(t)for(let e of t){let s=l.parse(e);if(!s)continue;let i=this.createButton(s);this.insertBefore(i,this.status)}}createButton(t){let e=document.createElement("a");return e.addEventListener("click",s=>{s.preventDefault();let i=new CustomEvent(t.type,{detail:t.value});this.dispatchEvent(i)}),e.innerHTML=t.title,e.href="#"+t.value,e}showRunning(){this.run.setAttribute("disabled",""),this.status.showRunning()}showFinished(t){this.run.removeAttribute("disabled"),this.status.showFinished(t)}showStatus(t){this.status.showMessage(t)}get editable(){return!this.edit.hasAttribute("hidden")}set editable(t){t?this.edit.removeAttribute("hidden"):this.edit.setAttribute("hidden","")}};function a(n){let t=document.createElement("div");return t.innerText=n,t.innerHTML}var E={running:"Running...",failed:"\u2718 Failed",done:"\u2713 Done"},p=class extends HTMLElement{showRunning(){let t=this.getAttribute("running")||E.running;this.innerHTML=`
            <svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"><animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12" repeatCount="indefinite"/></path></svg>
            ${t}
        `}showFinished(t){if(!t||!t.ok){this.innerHTML=this.getAttribute("failed")||E.failed;return}let e=this.getAttribute("done")||E.done;e=e.replace("$DURATION",t.duration),this.innerHTML=`
            ${e}
            <span data-ref>\u2022 <a href="https://codapi.org/">codapi</a></span>`}showMessage(t){this.innerHTML=a(t)}};var T=document.createElement("template");T.innerHTML=`
<a href="#close">\u2715</a>
<pre><code></code></pre>
`;var f=class extends HTMLElement{constructor(){super()}connectedCallback(){this.ready||(this.appendChild(T.content.cloneNode(!0)),this.close=this.querySelector("a"),this.output=this.querySelector("pre > code"),this.close.addEventListener("click",t=>{t.preventDefault(),this.hide()}),this.ready=!0)}fadeOut(){this.style.opacity=.4}fadeIn(){setTimeout(()=>{this.style.opacity=""},100)}showResult(t){let e=[];t.stdout&&e.push(a(t.stdout)),t.stderr&&e.push(a(t.stderr)),this.output.innerHTML=e.join(`
`),this.show()}showMessage(t){this.output.innerHTML=t,t?this.show():this.hide()}showError(t){let e=t.message+(t.stack?`
${t.stack}`:"");this.showMessage(e)}show(){this.removeAttribute("hidden")}hide(){this.setAttribute("hidden","")}};var D=async function(){}.constructor;async function $(n,t){try{let e=[];return j(e),{ok:!0,duration:await R(t.files[""]),stdout:e.join(`
`),stderr:""}}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}finally{O()}}async function R(n){let t=new D(n),e=new Date;return await t(),new Date-e}function j(n){let t=new Proxy(console,{get(e,s){return s==="log"||s==="error"||s==="warn"?(...i)=>{let o=i.map(d=>I(d)).join(" ");n.push(o),e[s](...i)}:e[s]}});window._console=window.console,window.console=t,window.addEventListener("error",e=>console.log(e.error))}function O(){window.console=window._console,delete window._console}function I(n){switch(typeof n){case"undefined":return"undefined";case"object":return JSON.stringify(n);default:return n.toString()}}var A={exec:$};async function m(n,t={}){let{timeout:e=1e4}=t,s=new AbortController,i=setTimeout(()=>s.abort(),e),o=await fetch(n,{...t,signal:s.signal});return clearTimeout(i),o}var N="https://api.codapi.org/v1",B="Something is wrong with Codapi.",P="Either Codapi is down or there is a network problem.",U={400:"Bad request. Something is wrong with the request, not sure what.",404:"Unknown sandbox or command.",403:"Forbidden. Your domain is probably not allowed on Codapi.",413:"Request is too large. Try submitting less code.",429:"Too many requests. Try again in a few seconds."};async function _(n,t){try{let e=`${n||N}/exec`,s=await m(e,{method:"POST",headers:{accept:"application/json","content-type":"application/json"},body:JSON.stringify(t)});if(!s.ok){let i=U[s.status]||B;return{ok:!1,duration:0,stdout:"",stderr:`${s.status} - ${i}`}}return await s.json()}catch(e){return{ok:!1,duration:0,stdout:P,stderr:`(${e})`}}}var L={exec:_};async function z(n,t){try{let e=W(t.files[""]);e.url=J(e.url,n);let[s,i]=await K(e);return{ok:!0,duration:i,stdout:s,stderr:""}}catch(e){return{ok:!1,duration:0,stdout:"",stderr:e.toString()}}}function W(n){let t=n.split(`
`),e=0,s=t[0].split(" ").filter(r=>r),[i,o]=s.length>=2?s:["GET",s[0]];e+=1;let d=[];for(let r=e;r<t.length;r++){let u=t[r].trim();if(u.startsWith("?")||u.startsWith("&"))d.push(u),e+=1;else break}let y={};for(let r=e;r<t.length;r++){let u=t[r].trim();if(u==="")break;let[H,F]=u.split(":");y[H.trim()]=F.trim(),e+=1}let C=t.slice(e+1).join(`
`);return{method:i,url:o+d.join(""),headers:y,body:C}}function J(n,t){if(!t)return n;let e=new URL(n),s=new URL(t);return e.protocol=s.protocol,e.username=s.username,e.password=s.password,e.host=s.host,e.pathname=s.pathname,e.href}async function K(n){let t=new Date,e=await G(n),s=await V(e),i=new Date-t;return[s,i]}async function G(n){let t={method:n.method,headers:n.headers,body:n.body||void 0};return await m(n.url,t)}async function V(n){let t="HTTP/1.1",e=await n.text(),s=[`${t} ${n.status} ${n.statusText}`];for(let i of n.headers.entries())s.push(`${i[0]}: ${i[1]}`);return e&&s.push("",e),s.join(`
`)}var k={exec:z};var Y="run",Z={javascript:A.exec,fetch:k.exec},w=class{constructor({sandbox:t,command:e,url:s,template:i,files:o}){this.sandbox=t,this.command=e||Y,this.url=s,this.template=i,this.files=o,this.execFunc=Z[t]||L.exec}async execute(t,e){e=await this.prepare(e);let s=await this.loadFiles();return await this.execFunc(this.url,{sandbox:this.sandbox,command:t||this.command,files:{"":e,...s}})}async prepare(t){if(!this.template)return t;let e="##CODE##",[s,i]=await M(this.template);return t=i.replace(e,t),t}async loadFiles(){if(!this.files)return{};let t={};for(let e of this.files){let[s,i]=await M(e);t[s]=i}return t}};async function M(n){try{if(n[0]=="#"){let i=n.slice(1),o=document.getElementById(i).text;return[i,o]}let t=n.split("/").pop(),s=await(await fetch(n)).text();return[t,s]}catch(t){throw new Error(`file ${n} not found`,{cause:t})}}var Q=4,c={unknown:"unknown",running:"running",failed:"failed",succeded:"succeded"},b={off:"off",basic:"basic",external:"external"},S=document.createElement("template");S.innerHTML=`
<codapi-toolbar></codapi-toolbar>
<codapi-output hidden></codapi-output>
`;var g=class extends HTMLElement{constructor(){super(),this.ready=!1,this.executor=null,this.snippet=null,this.toolbar=null,this.output=null}connectedCallback(){this.ready||(this.init(),this.render(),this.listen(),this.ready=!0)}init(){let t=this.getAttribute("files");this.executor=new w({sandbox:this.getAttribute("sandbox"),command:this.getAttribute("command"),url:this.getAttribute("url"),template:this.getAttribute("template"),files:t?t.split(" "):null}),this.state=c.unknown}render(){this.appendChild(S.content.cloneNode(!0));let t=this.findCodeElement();this.snippet=new x(t,this.editor,this.execute.bind(this)),this.toolbar=this.querySelector("codapi-toolbar");let e=this.getAttribute("actions");this.toolbar.addActions(e?e.split(" "):null);let s=this.toolbar.querySelector("codapi-status");this.hasAttribute("status-running")&&s.setAttribute("running",this.getAttribute("status-running")),this.hasAttribute("status-failed")&&s.setAttribute("failed",this.getAttribute("status-failed")),this.hasAttribute("status-done")&&s.setAttribute("done",this.getAttribute("status-done")),this.output=this.querySelector("codapi-output"),this.hasAttribute("output")&&this.showSampleOutput(this.getAttribute("output"))}listen(){this.toolbar.addEventListener("run",t=>{this.execute()}),this.toolbar.addEventListener("command",t=>{this.execute(t.detail)}),this.toolbar.addEventListener("event",t=>{this.dispatchEvent(new Event(t.detail))}),this.editor==b.basic&&(this.toolbar.editable=!0,this.toolbar.addEventListener("edit",t=>{this.snippet.focusEnd()})),this.snippet.addEventListener("hide",t=>{this.output.hide()})}findCodeElement(){if(this.selector)return document.querySelector(this.selector);let t=this.previousElementSibling;return t.querySelector("code")||t}async execute(t=void 0){if(!this.code){this.output.showMessage("(empty)");return}try{this.dispatchEvent(new CustomEvent("execute",{detail:this.code})),this.state=c.running,this.toolbar.showRunning(),this.output.fadeOut();let e=await this.executor.execute(t,this.code);this.state=e.ok?c.succeded:c.failed,this.toolbar.showFinished(e),this.output.showResult(e),this.dispatchEvent(new CustomEvent("result",{detail:e}))}catch(e){this.state=c.failed,this.toolbar.showFinished(null),this.output.showError(e),this.dispatchEvent(new CustomEvent("error",{detail:e}))}finally{this.output.fadeIn()}}showSampleOutput(t){let e=t==""?this.nextElementSibling:document.querySelector(t);e&&(e=e.querySelector("code")||e,this.output.showMessage(e.innerHTML),e.parentElement.removeChild(e))}showStatus(t){this.toolbar.showStatus(t)}get selector(){return this.getAttribute("selector")}get editor(){return this.getAttribute("editor")||b.off}get code(){return this.snippet.value}set code(t){this.snippet.value=t}get state(){return this.getAttribute("state")}set state(t){this.setAttribute("state",t)}},x=class extends EventTarget{constructor(t,e,s){super(),this.el=t,this.mode=e,this.executeFunc=s,this.listen()}listen(){if(this.mode!=b.off){if(this.mode==b.external){this.el.addEventListener("keydown",this.handleExecute.bind(this));return}this.el.contentEditable="true",this.el.addEventListener("keydown",this.handleIndent.bind(this)),this.el.addEventListener("keydown",this.handleHide.bind(this)),this.el.addEventListener("keydown",this.handleExecute.bind(this)),this.el.addEventListener("paste",this.onPaste.bind(this)),this.onFocus=this.initEditor.bind(this),this.el.addEventListener("focus",this.onFocus)}}initEditor(t){let e=t.target;e.innerHTML.includes("</span>")&&(e.innerHTML=e.innerText.replace(/\n\n/g,`
`)),e.removeEventListener("focus",this.onFocus),delete this.onFocus}handleIndent(t){t.key=="Tab"&&(t.preventDefault(),document.execCommand("insertHTML",!1," ".repeat(Q)))}handleHide(t){t.key=="Escape"&&(t.preventDefault(),this.dispatchEvent(new Event("hide")))}handleExecute(t){!t.ctrlKey&&!t.metaKey||t.keyCode!=10&&t.keyCode!=13||(t.preventDefault(),this.executeFunc())}onPaste(t){t.preventDefault();let e=(t.originalEvent||t).clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}focusEnd(){this.el.focus();let t=window.getSelection();t.selectAllChildren(this.el),t.collapseToEnd()}get value(){return this.el.innerText.trim()}set value(t){this.el.innerHTML=a(t)}};window.customElements.get("codapi-snippet")||(window.CodapiSnippet=g,customElements.define("codapi-toolbar",h),customElements.define("codapi-status",p),customElements.define("codapi-output",f),customElements.define("codapi-snippet",g));})();
